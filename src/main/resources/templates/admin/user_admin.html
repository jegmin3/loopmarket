<!-- ìœ ì € ê´€ë¦¬ í˜ì´ì§€ -->
<div th:fragment="content">
  <div class="container py-4">
    <h2 class="fw-bold fs-4 mb-4">ğŸ‘¤ ìœ ì € ê´€ë¦¬</h2>

    <!-- ëª¨ë°”ì¼ ì¹´ë“œ ë·° -->
    <div class="d-block d-md-none">
      <div th:each="member : ${members}" class="card mb-3 shadow-sm">
        <div class="card-body">
          <h6 class="card-title fw-bold mb-2">ë‹‰ë„¤ì„: <span th:text="${member.nickname}">ë‹‰ë„¤ì„</span></h6>
          <p class="mb-1"><strong>ID:</strong> <span th:text="${member.userId}">1</span></p>
          <p class="mb-1"><strong>ì´ë©”ì¼:</strong> <span th:text="${member.email}">email</span></p>
          <p class="mb-1"><strong>ì´ë¦„:</strong> <span th:text="${member.name}">í™ê¸¸ë™</span></p>
          <p class="mb-1"><strong>ê°€ì…ì¼:</strong> <span th:text="${#temporals.format(member.createdAt, 'yyyy-MM-dd HH:mm')}">ë‚ ì§œ</span></p>
          <p class="mb-2"><strong>ìƒíƒœ:</strong> <span th:text="${userStatusMap[member.userId]}">ACTIVE</span></p>

          <!-- ìƒíƒœ ë³€ê²½ -->
          <form th:action="@{/admin/user/changeStatus}" method="post" class="mb-2">
            <input type="hidden" name="userId" th:value="${member.userId}" />
            <input type="hidden" name="page" th:value="${currentPage}" />
            <div class="input-group">
              <select name="newStatus" class="form-select">
                <option value="ACTIVE" th:selected="${userStatusMap[member.userId] == 'ACTIVE'}">ACTIVE</option>
                <option value="SUSPENDED" th:selected="${userStatusMap[member.userId] == 'SUSPENDED'}">SUSPENDED</option>
              </select>
              <button type="submit" class="btn btn-outline-primary">ë³€ê²½</button>
            </div>
          </form>

          <!-- ê¶Œí•œ ë³€ê²½ -->
          <div th:if="${currentUserRole != null}" th:switch="${currentUserRole.name()}">
            <div th:case="'ADMIN'">
              <span th:if="${currentUserId == member.userId}" class="text-muted">ë³¸ì¸ ê¶Œí•œ ë³€ê²½ ë¶ˆê°€</span>
              <form th:if="${currentUserId != member.userId}" th:action="@{/admin/user/changeRole}" method="post">
                <input type="hidden" name="userId" th:value="${member.userId}" />
                <input type="hidden" name="page" th:value="${currentPage}" />
                <div class="input-group">
                  <select name="newRole" class="form-select">
                    <option value="USER" th:selected="${member.role.name() == 'USER'}">USER</option>
                    <option value="BUSINESS" th:selected="${member.role.name() == 'BUSINESS'}">BUSINESS</option>
                    <option value="MANAGER" th:selected="${member.role.name() == 'MANAGER'}">MANAGER</option>
                  </select>
                  <button type="submit" class="btn btn-outline-secondary">ë³€ê²½</button>
                </div>
              </form>
            </div>
            <div th:case="*">
              <span class="text-muted">ê¶Œí•œ ë³€ê²½ ë¶ˆê°€</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ë°ìŠ¤í¬íƒ‘ í…Œì´ë¸” -->
    <div class="table-responsive d-none d-md-block">
      <table class="table table-hover align-middle text-center border rounded shadow-sm">
        <thead class="table-light">
          <tr class="align-middle">
            <th>ID</th>
            <th>ì´ë©”ì¼</th>
            <th>ë‹‰ë„¤ì„</th>
            <th>ì´ë¦„</th>
            <th>ê°€ì…ì¼</th>
            <th>ìƒíƒœ</th>
            <th>ìƒíƒœ ë³€ê²½</th>
            <th>ê¶Œí•œ ë³€ê²½</th>
          </tr>
        </thead>
        <tbody>
          <tr th:each="member : ${members}" class="align-middle">
            <td th:text="${member.userId}">1</td>
            <td th:text="${member.email}">email</td>
            <td th:text="${member.nickname}">ë‹‰ë„¤ì„</td>
            <td th:text="${member.name}">í™ê¸¸ë™</td>
            <td th:text="${#temporals.format(member.createdAt, 'yyyy-MM-dd HH:mm')}">ê°€ì…ì¼</td>
            <td th:text="${userStatusMap[member.userId]}">ACTIVE</td>
            <td>
              <form th:action="@{/admin/user/changeStatus}" method="post" class="d-flex justify-content-center align-items-center gap-1">
                <input type="hidden" name="userId" th:value="${member.userId}" />
                <input type="hidden" name="page" th:value="${currentPage}" />
                <select name="newStatus" class="form-select form-select-sm w-auto">
                  <option value="ACTIVE" th:selected="${userStatusMap[member.userId] == 'ACTIVE'}">ACTIVE</option>
                  <option value="SUSPENDED" th:selected="${userStatusMap[member.userId] == 'SUSPENDED'}">SUSPENDED</option>
                </select>
                <button type="submit" class="btn btn-sm btn-outline-primary">ë³€ê²½</button>
              </form>
            </td>
            <td>
              <div th:if="${currentUserRole != null}" th:switch="${currentUserRole.name()}">
                <div th:case="'ADMIN'">
                  <span th:if="${currentUserId == member.userId}" class="text-muted">ë³¸ì¸ ê¶Œí•œ ë³€ê²½ ë¶ˆê°€</span>
                  <form th:if="${currentUserId != member.userId}" th:action="@{/admin/user/changeRole}" method="post" class="d-flex justify-content-center align-items-center gap-1">
                    <input type="hidden" name="userId" th:value="${member.userId}" />
                    <input type="hidden" name="page" th:value="${currentPage}" />
                    <select name="newRole" class="form-select form-select-sm w-auto">
                      <option value="USER" th:selected="${member.role.name() == 'USER'}">USER</option>
                      <option value="BUSINESS" th:selected="${member.role.name() == 'BUSINESS'}">BUSINESS</option>
                      <option value="MANAGER" th:selected="${member.role.name() == 'MANAGER'}">MANAGER</option>
                    </select>
                    <button type="submit" class="btn btn-sm btn-outline-secondary">ë³€ê²½</button>
                  </form>
                </div>
                <div th:case="*">
                  <span class="text-muted">ê¶Œí•œ ë³€ê²½ ë¶ˆê°€</span>
                </div>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- í˜ì´ì§• -->
    <nav aria-label="Page navigation" class="mt-4">
      <ul class="pagination justify-content-center flex-wrap">
        <li class="page-item" th:classappend="${currentPage == 0} ? 'disabled'">
          <a class="page-link" th:href="@{/admin/user(page=${currentPage - 1})}">ì´ì „</a>
        </li>
        <li class="page-item" th:each="i : ${#numbers.sequence(0, totalPages - 1)}" th:classappend="${i == currentPage} ? 'active'">
          <a class="page-link" th:href="@{/admin/user(page=${i})}" th:text="${i + 1}">1</a>
        </li>
        <li class="page-item" th:classappend="${currentPage + 1 >= totalPages} ? 'disabled'">
          <a class="page-link" th:href="@{/admin/user(page=${currentPage + 1})}">ë‹¤ìŒ</a>
        </li>
      </ul>
    </nav>
  </div>
</div>
	
	<script>
	    function bindUserStatusFormEvents() {
	        document.querySelectorAll('.user-status-form').forEach(form => {
	            form.addEventListener('submit', function (e) {
	                e.preventDefault();

	                const formData = new FormData(form);
	                const page = form.querySelector('input[name="page"]').value;

	                fetch(form.getAttribute('action'), {
	                    method: 'POST',
	                    body: formData,
	                    headers: {
	                        'X-Requested-With': 'XMLHttpRequest'
	                    }
	                })
	                .then(response => response.json())
	                .then(data => {
	                    if (data.success) {
	                        Swal.fire({
	                            icon: 'success',
	                            title: 'ìƒíƒœ ë³€ê²½ ì„±ê³µ',
	                            text: data.message,
	                            timer: 1500,
	                            showConfirmButton: false
	                        }).then(() => {
	                            loadAdminPage('/admin/user?page=' + page);
	                        });
	                    } else {
	                        Swal.fire({
	                            icon: 'error',
	                            title: 'ì‹¤íŒ¨',
	                            text: data.message
	                        });
	                    }
	                })
	                .catch(error => {
	                    Swal.fire({
	                        icon: 'error',
	                        title: 'ì—ëŸ¬ ë°œìƒ',
	                        text: 'ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.'
	                    });
	                    console.error('ì˜¤ë¥˜:', error);
	                });
	            });
	        });
	    }
		function bindUserRoleFormEvents() {
		    document.querySelectorAll('.user-role-form').forEach(form => {
		        form.addEventListener('submit', function (e) {
		            e.preventDefault();

		            const formData = new FormData(form);
		            const page = form.querySelector('input[name="page"]').value;

		            fetch(form.getAttribute('action'), {
		                method: 'POST',
		                body: formData,
		                headers: {
		                    'X-Requested-With': 'XMLHttpRequest'
		                }
		            })
		            .then(response => response.json())
		            .then(data => {
		                if (data.success) {
		                    Swal.fire({
		                        icon: 'success',
		                        title: 'ê¶Œí•œ ë³€ê²½ ì„±ê³µ',
		                        text: data.message,
		                        timer: 1500,
		                        showConfirmButton: false
		                    }).then(() => {
		                        loadAdminPage('/admin/user?page=' + page);
		                    });
		                } else {
		                    Swal.fire({
		                        icon: 'error',
		                        title: 'ì‹¤íŒ¨',
		                        text: data.message
		                    });
		                }
		            })
		            .catch(error => {
		                Swal.fire({
		                    icon: 'error',
		                    title: 'ì—ëŸ¬ ë°œìƒ',
		                    text: 'ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.'
		                });
		                console.error('ì˜¤ë¥˜:', error);
		            });
		        });
		    });
		}

	    function bindPaginationEvents() {
	        document.querySelectorAll('.user-page-link').forEach(link => {
	            link.addEventListener('click', function (e) {
	                e.preventDefault();
	                const page = this.getAttribute('data-page');
	                loadAdminPage('/admin/user?page=' + page);
	            });
	        });
	    }

		function loadAdminPage(url) {
		    const container = document.getElementById('admin-content');

		    // ê¸°ë³¸ ë¡œë”© í…ìŠ¤íŠ¸ì™€ ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘
		    container.innerHTML = `<div class="text-center mt-5"><p id="loading-text">Loading.</p></div>`;

		    const loadingText = document.getElementById('loading-text');
		    let dotCount = 1;

		    // ì  ì• ë‹ˆë©”ì´ì…˜: . .. ... ë°˜ë³µ
		    const loadingInterval = setInterval(() => {
		        dotCount = (dotCount % 3) + 1;
		        loadingText.textContent = 'Loading' + '.'.repeat(dotCount);
		    }, 500);

		    fetch(url, {
		        headers: { 'X-Requested-With': 'XMLHttpRequest' }
		    })
		    .then(res => res.text())
		    .then(html => {
		        clearInterval(loadingInterval); // ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ ì¤‘ì§€
		        container.innerHTML = html;

		        // ì´ë²¤íŠ¸ ì¬ë°”ì¸ë”©
		        bindUserStatusFormEvents();
		        bindUserRoleFormEvents();
		        bindPaginationEvents();
		    })
		    .catch(err => {
		        clearInterval(loadingInterval); // ì‹¤íŒ¨ ì‹œì—ë„ ì¤‘ì§€
		        console.error('í˜ì´ì§€ ë¡œë“œ ì‹¤íŒ¨:', err);
		        container.innerHTML = '<p style="color:red;">í˜ì´ì§€ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>';
		    });
		}

	    // âœ… ì´ˆê¸° ë°”ì¸ë”© ìˆ˜ë™ í˜¸ì¶œ
	    bindUserStatusFormEvents();
		bindUserRoleFormEvents();
	    bindPaginationEvents();
	</script>
	
	<style>
		.card-title {
		        font-size: 1.1rem;
		        font-weight: bold;
		    }

		    .form-select {
		        min-width: 120px;
		    }

		    .input-group > select,
		    .input-group > button {
		        flex: 1 1 auto;
		    }
	        /* ë²„íŠ¼ ì¤„ë°”ê¿ˆ ë°©ì§€ */
	        .change-status-btn,
	        .change-role-btn {
	            white-space: nowrap;
	            text-overflow: ellipsis;
	            overflow: hidden;
	        }

	        /* í¼ ì•ˆ ìš”ì†Œë“¤ í•œ ì¤„ ì •ë ¬ & ê°„ê²© ìœ ì§€ */
	        .user-status-form,
	        .user-role-form {
	            display: flex;
	            flex-wrap: nowrap; /* ì¤„ë°”ê¿ˆ ë°©ì§€ */
	            justify-content: center;
	            align-items: center;
	            gap: 4px;
	        }

	        /* í…Œì´ë¸” ë°˜ì‘í˜• - ëª¨ë°”ì¼ì—ì„œ ìˆ˜í‰ ìŠ¤í¬ë¡¤ ê°€ëŠ¥í•˜ê²Œ */
	        .table-responsive {
	            overflow-x: auto;
	            -webkit-overflow-scrolling: touch;
	        }

	        /* í…Œì´ë¸” ì…€ ê°€ìš´ë° ì •ë ¬, ì¤„ë°”ê¿ˆ ê°€ëŠ¥í•˜ë„ë¡ ì¡°ì • */
	        .table td,
	        .table th {
	            white-space: normal; /* ì¤„ë°”ê¿ˆ í—ˆìš© */
	            vertical-align: middle;
	            text-align: center;
	        }

	        /* select ìš”ì†Œë„ ë„ˆë¬´ ì‘ì§€ ì•Šê²Œ ìë™ ë„ˆë¹„ë¡œ */
	        .form-control-sm {
	            min-width: 80px;
	        }

	        /* ëª¨ë°”ì¼ ëŒ€ì‘ ë¯¸ë””ì–´ ì¿¼ë¦¬ */
	        @media (max-width: 576px) {
	            .container {
	                padding-left: 0.5rem;
	                padding-right: 0.5rem;
	            }

	            h2.userPage {
	                font-size: 1.2rem;
	                margin-bottom: 1rem;
	                word-break: break-word;
	            }

	            .table {
	                font-size: 0.8rem;
	            }

	            .user-status-form select,
	            .user-role-form select {
	                min-width: 60px;
	                font-size: 0.75rem;
	            }

	            .change-status-btn,
	            .change-role-btn {
	                font-size: 0.75rem;
	                padding: 0.25rem 0.5rem;
	                min-width: 60px;
	            }

	            /* í˜ì´ì§• ë²„íŠ¼ í¬ê¸° ì¶•ì†Œ */
	            .pagination .page-link {
	                padding: 0.25rem 0.5rem;
	                font-size: 0.75rem;
	            }
	        }
			
	    </style>

	</div>