<!-- templates/chat/chatRoom.html -->
<div th:fragment="content">
	
	<!-- SockJS, StompJS ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¶”ê°€ -->
	<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

	
    <h4 class="mb-4">ğŸ’¬ <span th:text="${targetNickname}">ìƒëŒ€ë°© ë‹‰ë„¤ì„</span> ë‹˜ê³¼ì˜ ì±„íŒ…</h4>

    <!-- ë©”ì‹œì§€ ì¶œë ¥ ì˜ì—­ -->
	<div id="chatArea" class="border p-3 rounded overflow-auto" style="height: 400px; background-color: #f9f9f9;">
	    <div th:each="msg : ${messageList}" class="mb-2">

	        <!-- ë‚´ê°€ ë³´ë‚¸ ë©”ì‹œì§€ -->
	        <div th:if="${msg.senderId == loginUser.userId}" class="text-end">
	            <div class="d-inline-block p-2 rounded bg-primary text-white">
	                <span th:text="${msg.content}" style="font-size: 1.05rem;"></span><br/>
	                <small class="text-light">
	                    <span th:text="${#temporals.format(msg.sentAt, 'HH:mm')}">00:00</span>
	                    <span th:text="${msg.read ? 'âœ”âœ”' : 'âœ”'}"></span>
	                </small>
	            </div>
	        </div>

	        <!-- ìƒëŒ€ë°©ì´ ë³´ë‚¸ ë©”ì‹œì§€ -->
	        <div th:if="${msg.senderId != loginUser.userId}" class="text-start">
	            <div class="d-inline-block p-2 rounded bg-light border">
	                <span th:text="${msg.content}" style="font-size: 1.05rem;"></span><br/>
	                <small class="text-muted">
	                    <span th:text="${#temporals.format(msg.sentAt, 'HH:mm')}">00:00</span>
	                </small>
	            </div>
	        </div>

	    </div>
	</div>

    <!-- ì…ë ¥ì°½ -->
    <form id="chatForm" class="mt-3 d-flex">
        <input type="text" id="msgInput" class="form-control me-2" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
        <button type="submit" class="btn btn-outline-success">ì „ì†¡</button>
    </form>

	<!-- ì±„íŒ…ë°© ë‚˜ê°€ê¸° ë²„íŠ¼ -->
	<button id="leaveBtn" class="btn btn-outline-danger btn-sm mt-2">ì±„íŒ…ë°© ë‚˜ê°€ê¸°</button>

	<form id="leaveForm" th:action="@{/chat/leave}" method="post" style="display: none;">
	    <input type="hidden" name="roomId" th:value="${roomId}" />
	</form>

    <!-- JSëŠ” ì•„ë˜ì— ë°°ì¹˜ -->
    <script th:inline="javascript">
        let stompClient = null;
		const roomId = /*[[${roomId}]]*/ 0;
		const senderId = /*[[${session.loginUser.userId}]]*/ 0;

        // WebSocket ì—°ê²°
        function connect() {
            const socket = new SockJS("/ws/chat");
            stompClient = Stomp.over(socket);

            stompClient.connect({}, function () {
                console.log("ğŸ”Œ WebSocket ì—°ê²°ë¨");

                stompClient.subscribe(`/queue/room.${roomId}`, function (message) {
                    const msg = JSON.parse(message.body);
                    showMessage(msg);
                });

                // ì…ì¥ ì‹œ ì½ìŒ ì²˜ë¦¬
                stompClient.send("/app/chat.read", {}, JSON.stringify({
                    roomId: roomId,
                    senderId: senderId
                }));
            });
        }
		
		// ì±„íŒ…ë°© ë‚˜ê°€ê¸° sweetAlert ì²˜ë¦¬
		$("#leaveBtn").click(function () {
		    Swal.fire({
		        title: "ì±„íŒ…ë°©ì„ ë‚˜ê°€ì‹œê² ìŠµë‹ˆê¹Œ?",
		        text: "ë‚˜ê°€ë©´ ì±„íŒ…ë°©ì—ì„œ ì‚¬ë¼ì§€ê³ , ìƒëŒ€ë„ ë‚˜ê°€ë©´ ì „ì²´ ì‚­ì œë©ë‹ˆë‹¤.",
		        icon: "warning",
		        showCancelButton: true,
		        confirmButtonText: "ë„¤, ë‚˜ê°ˆê²Œìš”",
		        cancelButtonText: "ì·¨ì†Œ",
		        reverseButtons: true
		    }).then((result) => {
		        if (result.isConfirmed) {
		            $("#leaveForm").submit();
		        }
		    });
		});
		
        // ë©”ì‹œì§€ ì „ì†¡
        $("#chatForm").submit(function (e) {
            e.preventDefault();
            const content = $("#msgInput").val().trim();
            if (!content) return;

            stompClient.send("/app/chat.send", {}, JSON.stringify({
                roomId: roomId,
                senderId: senderId,
                content: content,
                type: "CHAT"
            }));

            $("#msgInput").val("");
        });

        // ë©”ì‹œì§€ ì¶œë ¥
		function showMessage(msg) {
		    const chatArea = $("#chatArea");
		    const isMine = (msg.senderId === senderId);
		    const align = isMine ? "text-end" : "text-start";
		    const bubble = isMine ? "bg-primary text-white" : "bg-light border text-dark";

		    const time = msg.timestamp?.substring(11, 16) || "00:00"; // 'YYYY-MM-DDTHH:mm:ss'ì—ì„œ HH:mm ì¶”ì¶œ
		    const readIcon = isMine ? (msg.read ? "âœ”âœ”" : "âœ”") : "";

		    const html = `
		        <div class="${align} mb-2">
		            <div class="d-inline-block p-2 rounded ${bubble}">
		                <div style="font-size: 1.05rem;">${msg.content}</div>
		                <small class="${isMine ? 'text-light' : 'text-muted'}">
		                    ${time} ${readIcon}
		                </small>
		            </div>
		        </div>`;

		    chatArea.append(html);
		    chatArea.scrollTop(chatArea[0].scrollHeight);
		}
    </script>

</div>
