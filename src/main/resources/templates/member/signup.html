<!-- íšŒì›ê°€ì… ì¡°ê°ë·° -->
<div th:fragment="content" class="container mt-5" style="max-width: 500px;">
	<!-- ì¹´ë“œ í˜•íƒœì˜ íšŒì›ê°€ì… í¼ ì˜ì—­ -->
	<div class="card shadow rounded-4 p-4">
		<h3 class="text-center mb-4">
			<i class="bi bi-person-plus-fill me-2"></i>íšŒì›ê°€ì…
		</h3>

		<!-- íšŒì›ê°€ì… í¼ ì‹œì‘ -->
		<form id="signupForm" method="post" th:action="@{/member/signup}">

			<!-- ğŸ”¹ ì´ë©”ì¼ ì…ë ¥ ì˜ì—­ -->
			<label class="form-label small fw-bold">
				<i class="bi bi-envelope-fill me-1"></i>ì´ë©”ì¼
			</label>
			<div class="row g-2 align-items-center mb-2">
				<!-- ì´ë©”ì¼ ì•„ì´ë”” ì…ë ¥ -->
				<div class="col-5">
					<input type="text" id="emailId" class="form-control form-control-sm" placeholder="ì´ë©”ì¼" required>
				</div>
				<div class="col-auto">
					<span class="form-text">@</span>
				</div>

				<!-- ë„ë©”ì¸ ì„ íƒ ë“œë¡­ë‹¤ìš´ -->
				<div class="col-5">
					<select id="emailDomainSelect" class="form-select form-select-sm">
						<option value="naver.com">naver.com</option>
						<option value="gmail.com">gmail.com</option>
						<option value="daum.net">daum.net</option>
						<option value="self">ì§ì ‘ì…ë ¥</option>
					</select>
				</div>

				<!-- ì§ì ‘ì…ë ¥ ë„ë©”ì¸ í…ìŠ¤íŠ¸ë°•ìŠ¤ (ê¸°ë³¸ì€ ë¹„í™œì„±í™”) -->
				<div class="col-12 mt-2">
					<input type="text" id="emailDomainCustom" class="form-control form-control-sm" placeholder="ì§ì ‘ì…ë ¥"
						disabled>
				</div>
			</div>

			<!-- ğŸ”¹ ì´ë©”ì¼ ì¸ì¦ ì˜ì—­ -->
			<div class="row g-2 align-items-center mb-3">
				<!-- ì¸ì¦í•˜ê¸° ë²„íŠ¼ -->
				<div class="col-auto">
					<button type="button" class="btn btn-outline-primary btn-sm" id="sendCodeBtn">
						<i class="bi bi-send-check me-1"></i>ì¸ì¦í•˜ê¸°
					</button>
				</div>

				<!-- ì¸ì¦ì½”ë“œ ì…ë ¥ -->
				<div class="col">
					<input type="text" id="emailCode" class="form-control form-control-sm" placeholder="ì¸ì¦ì½”ë“œ ì…ë ¥"
						style="display:none;">
				</div>

				<!-- ì¸ì¦ í™•ì¸ ë²„íŠ¼ -->
				<div class="col-auto">
					<button type="button" class="btn btn-sm btn-success" id="verifyCodeBtn" style="display:none;">
						<i class="bi bi-check2-circle"></i>
					</button>
				</div>
			</div>

			<!-- ì¸ì¦ ê²°ê³¼ ë©”ì‹œì§€ ë° hidden ë°ì´í„° -->
			<div id="emailVerifyResult" class="small text-muted mb-3"></div>
			<input type="hidden" name="emailVerified" id="emailVerified" value="false">
			<input type="hidden" name="email" id="email"> <!-- ì‹¤ì œ ì„œë²„ì— ì „ì†¡ë  ìµœì¢… ì´ë©”ì¼ -->

			<!-- ğŸ”¹ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ -->
			<div class="position-relative">
			  <label class="form-label small fw-bold">
			    <i class="bi bi-lock-fill me-1"></i>ë¹„ë°€ë²ˆí˜¸
			  </label>
			  <input type="password" name="password" id="passwordInput" class="form-control mb-3" placeholder="ë¹„ë°€ë²ˆí˜¸" required>
			  <!-- ë¹„ë°€ë²ˆí˜¸ ë³´ê¸°/ìˆ¨ê¸°ê¸° í† ê¸€ ë²„íŠ¼ -->
			  <i class="bi bi-eye-slash toggle-password"
			     style="position: absolute; top: 38px; right: 12px; cursor: pointer;"></i>
			</div>
			
			<!-- ğŸ”¹ ë‹‰ë„¤ì„ ì…ë ¥ -->
			<label class="form-label small fw-bold">
				<i class="bi bi-person-badge-fill me-1"></i>ë‹‰ë„¤ì„
			</label>
			<input type="text" name="nickname" class="form-control mb-3" placeholder="ë‹‰ë„¤ì„" required>

			<!-- ğŸ”¹ íšŒì›ê°€ì… ë²„íŠ¼ -->
			<button type="submit" class="btn btn-primary w-100 mt-2">
				<i class="bi bi-person-plus-fill me-1"></i>íšŒì›ê°€ì…
			</button>

			<!-- ğŸ”¹ ë¡œê·¸ì¸ ë§í¬ -->
			<div class="mt-3 text-center">
				<a href="/member/login" class="text-decoration-none small">
					<i class="bi bi-box-arrow-in-right me-1"></i>ì´ë¯¸ ê³„ì •ì´ ìˆìœ¼ì‹ ê°€ìš”?
				</a>
			</div>
		</form>
		<!-- íšŒì›ê°€ì… í¼ ë -->
	</div>

	<script>
		let verified = false;
		// ë¹„ë²ˆ ë³´ê¸°ì•ˆë³´ê¸° í† ê¸€
		$(document).ready(function () {
		  $(".toggle-password").on("click", function () {
		    const $icon = $(this);
		    const $input = $("#passwordInput");
		    const type = $input.attr("type");

		    // í† ê¸€: password <-> text
		    if (type === "password") {
		      $input.attr("type", "text");
		      $icon.removeClass("bi-eye-slash").addClass("bi-eye");
		    } else {
		      $input.attr("type", "password");
		      $icon.removeClass("bi-eye").addClass("bi-eye-slash");
		    }
		  });
		});
		
		// ë„ë©”ì¸ ì„ íƒ ì‹œ ì§ì ‘ì…ë ¥ í™œì„±/ë¹„í™œì„± ì œì–´
		$("#emailDomainSelect").change(function () {
			const selected = $(this).val();
			if (selected === "self") {
				$("#emailDomainCustom").prop("disabled", false).focus(); // í™œì„±í™”
			} else {
				$("#emailDomainCustom").prop("disabled", true).val("");  // ë¹„í™œì„±í™” ë° ì´ˆê¸°í™”
			}
		});

		// ìµœì¢… ì´ë©”ì¼ ì£¼ì†Œ ê³„ì‚° í•¨ìˆ˜
		function getFullEmail() {
			const id = $("#emailId").val();
			const domain = ($("#emailDomainSelect").val() === "self") ?
				$("#emailDomainCustom").val() : $("#emailDomainSelect").val();
			return `${id}@${domain}`;
		}

		// ì´ë©”ì¼ ì¸ì¦í•˜ê¸° ë²„íŠ¼ ëˆ„ë¥¼ ì‹œ
		$("#sendCodeBtn").click(function () {
			// ìµœì¢… ì´ë©”ì¼ ì£¼ì†Œ ê°€ì ¸ì˜®
			const email = getFullEmail();
			// ì´ë©”ì¼ ê²€ì‚¬ìš© ì •ê·œí‘œí˜„ì‹
			function isValidEmail(email) {
				return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
			}
			// ì´ë©”ì¼ ìœ íš¨ì„± ê²€ì‚¬: ì•„ì´ë””, ë„ë©”ì¸ ë¹„ì–´ìˆëŠ”ì§€ + í˜•ì‹ ê°„ë‹¨ê²€ì‚¬
			if (!isValidEmail(email)) {
				return showAlert("warning", "ì…ë ¥ ì˜¤ë¥˜", "ì´ë©”ì¼ì„ ì •í™•íˆ ì…ë ¥í•´ì£¼ì„¸ìš”.");
			}

			$("#email").val(email); // hidden í•„ë“œì— ìµœì¢… ì´ë©”ì¼ ë„£ê¸°
			// ì´ë©”ì¼ ë°œì†¡ ë¡œì§ì „ ì–¼ëŸ¿ ë„ì›€. (ë°œì†¡ í›„ ì–¼ëŸ¿í•˜ë©´ ëŠë¦¬ê¸° ë•Œë¬¸ì—..)  
			showAlert("info", "ì „ì†¡ ì™„ë£Œ", "ì´ë©”ì¼ì„ í™•ì¸ í›„ ì¸ì¦ë²ˆí˜¸ë¥¼ ì…ë ¥ í•´ì£¼ì„¸ìš”.");
			$("#emailCode, #verifyCodeBtn").show(); // ì¸ì¦ë²ˆí˜¸ ì…ë ¥ì¹¸ ë°”ë¡œ í‘œì‹œ
			// ì´ë©”ì¼ ì…ë ¥ì¹¸ë“¤ ë¹„í™œì„±í™”
			$("#emailId").prop("readonly", true);               // input
			$("#emailDomainCustom").prop("readonly", true);     // input
			$("#emailDomainSelect").prop("disabled", true);     // select
			// ì¸ì¦í•˜ê¸° ë²„íŠ¼ ë¹„í™œì„±í™”
			$("#sendCodeBtn")						
			  .removeClass("btn-outline-primary")
			  .addClass("btn-secondary")
			  .prop("disabled", true);
			  
			// ì´ë©”ì¼ ì¸ì¦ ë°œì†¡ POST ìš”ì²­
			$.post("/api/email/send-code", {email}, function () {
				//$("#emailCode, #verifyCodeBtn").show();
				//showAlert("info", "ì „ì†¡ ì™„ë£Œ", "ì¸ì¦ì½”ë“œë¥¼ ì´ë©”ì¼ë¡œ ë³´ëƒˆìŠµë‹ˆë‹¤.");
				console.log("ì´ë©”ì¼ ì¸ì¦ë²ˆí˜¸ ì „ì†¡ë¨");
			});
		});
		// ì´ë©”ì¼ ì¸ì¦ í™•ì¸ ë²„íŠ¼
		$("#verifyCodeBtn").click(function () {
			const email = $("#email").val();
			const code = $("#emailCode").val();
			if (!code) return;

			$.post("/api/email/verify-code", {email, code}, function (res) {
				if (res.verified) {
					verified = true;
					// ì„±ê³µ ë©”ì‹œì§€ + ìƒ‰ìƒ
					$("#emailVerified").val("true");
					$("#emailVerifyResult").text("ì´ë©”ì¼ì´ ì¸ì¦ë˜ì—ˆìŠµë‹ˆë‹¤.")
					                       .css("color", "green");
				    //  SweetAlert í‘œì‹œ
				    showAlert("success", "ì¸ì¦ ì„±ê³µ", "ì´ë©”ì¼ ì¸ì¦ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!");
					
					// ì¸ì¦ í™•ì¸ ë²„íŠ¼: íšŒìƒ‰ìœ¼ë¡œ, ë¹„í™œì„±í™”
					$("#verifyCodeBtn")
					  .removeClass("btn-success")
					  .addClass("btn-secondary")
					  .prop("disabled", true);
					  
					$("#emailCode").prop("readonly", true); // ì¸ì¦ë²ˆí˜¸ ì…ë ¥ì¹¸ ë¹„í™œì„±í™”
				} else {
					verified = false;
					$("#emailVerified").val("false");
					// ì‹¤íŒ¨ ë©”ì‹œì§€ + ìƒ‰ìƒ
					$("#emailVerifyResult").text("ì¸ì¦ì½”ë“œê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.")
					                       .css("color", "red");
				    // ì‹¤íŒ¨ ì•Œë¦¼
				    showAlert("error", "ì¸ì¦ ì‹¤íŒ¨", "ì¸ì¦ì½”ë“œê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
				}
			});
		});
		// íšŒì›ê°€ì… í¼ ì œì¶œì‹œ
		$("#signupForm").submit(function (e) {
			if (!verified) {
				e.preventDefault();
				showAlert("error", "ì¸ì¦ í•„ìš”", "ì´ë©”ì¼ ì¸ì¦ì„ ì™„ë£Œí•´ì£¼ì„¸ìš”.");
			}
		});
	</script>
</div>