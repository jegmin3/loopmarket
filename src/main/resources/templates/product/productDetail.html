<div th:fragment="content">
  <div class="container my-5">
    <div class="row justify-content-center">
      <div class="col-md-10">
        <div class="row g-4">

          <!-- ì™¼ìª½: ì´ë¯¸ì§€ ìŠ¬ë¼ì´ë” + íŒë§¤ì ì •ë³´ -->
          <div class="col-md-6">

            <!-- ë’¤ë¡œê°€ê¸° ë²„íŠ¼ -->
            <div class="mb-2">
              <a th:href="@{/products}" class="btn btn-outline-secondary btn-sm">â† ëª©ë¡ìœ¼ë¡œ</a>
            </div>

            <!-- ì´ë¯¸ì§€ ìŠ¬ë¼ì´ë” -->
            <div class="position-relative" style="height: 300px; overflow: hidden;">
              <div class="slider-track d-flex"
                   th:if="${product.imagePaths != null}"
                   th:style="${#lists.size(product.imagePaths) == 1} ?
                   'width: 100%; height: 100%; transition: transform 0.5s ease;' :
                   'width:' + (${#lists.size(product.imagePaths)} * 100) + '%; height: 100%; transition: transform 0.5s ease;'"
                   th:attr="data-count=${product.imagePaths.size()}">

                <div th:each="img : ${product.imagePaths}"
                     th:style="${#lists.size(product.imagePaths) == 1} ?
                     'width: 100%; height: 100%; display: flex; align-items: center; justify-content: center;' :
                     'width:' + (100 / ${#lists.size(product.imagePaths)}) + '%; height: 100%; display: flex; align-items: center; justify-content: center; flex-shrink: 0;'">
                  <img th:src="@{${img}}" style="max-width: 100%; max-height: 100%; object-fit: contain;" />
                </div>
              </div>

              <button th:if="${product.imagePaths.size() > 1}"
                      class="slider-prev btn position-absolute top-50 start-0 translate-middle-y"
                      onclick="slideImage(this, -1, event)">â®</button>

              <button th:if="${product.imagePaths.size() > 1}"
                      class="slider-next btn position-absolute top-50 end-0 translate-middle-y"
                      onclick="slideImage(this, 1, event)">â¯</button>

            </div>

            <!-- ì´ë¯¸ì§€ dot -->
            <div th:if="${product.imagePaths.size() > 1}"
                 class="d-flex justify-content-center gap-1 mt-2">
              <span th:each="i : ${#numbers.sequence(0, #lists.size(product.imagePaths) - 1)}"
                    class="dot bg-dark rounded-circle"
                    th:attr="data-index=${i}"
                    style="width: 6px; height: 6px; opacity: 0.4;"></span>
            </div>

            <!-- íŒë§¤ì ì •ë³´ -->
            <a th:href="@{/sellers/{id}(id=${product.userId})}"
               class="d-flex align-items-center mt-3 text-decoration-none text-dark">
              <img th:src="${profileImagePath}"
                   alt="í”„ë¡œí•„ ì´ë¯¸ì§€"
                   class="rounded-circle border me-3"
                   style="width: 40px; height: 40px; object-fit: cover; aspect-ratio: 1 / 1;" />
              <div class="text-start text-muted small">
                íŒë§¤ì: <span class="fw-semibold" th:text="${product.sellerNickname}">ì •ë¯¼</span> Â·
                <span th:text="${product.relativeTime}">3ì¼ ì „</span>
              </div>
            </a>

          </div>

          <!-- ì˜¤ë¥¸ìª½: ìƒí’ˆ ì •ë³´ -->
          <div class="col-md-6">
            <h4 class="fw-bold mb-1" th:text="${product.title}">ìƒí’ˆ ì œëª©</h4>
            <h3 class="text-danger fw-bold mb-3"
                th:text="${#numbers.formatInteger(product.price, 3, 'COMMA')} + 'ì›'">ê°€ê²©</h3>

            <ul class="list-unstyled small">
              <li class="mb-2"><strong>ì„¤ëª…:</strong><br>
                <span th:text="${product.description}">ìƒí’ˆ ì„¤ëª…</span>
              </li>
              <li><strong>ìƒí’ˆ ìƒíƒœ:</strong> <span th:text="${product.condition}">USED</span></li>
              <li><strong>ê±°ë˜ ë°©ì‹:</strong>
                <span th:if="${product.saleType == 'SALE'}">íŒë§¤</span>
                <span th:if="${product.saleType == 'DONATION'}">ë‚˜ëˆ”</span>
              </li>
              <li><strong>í¬ë§ ë°©ì‹:</strong>
                <span th:if="${product.isDirect ?: false}">ì§ê±°ë˜ </span>
                <span th:if="${product.isDelivery ?: false}">íƒë°° </span>
                <span th:if="${product.isNonface ?: false}">ë¹„ëŒ€ë©´</span>
              </li>
              <li><strong>ê±°ë˜ ìœ„ì¹˜:</strong><br>
                <span th:text="${product.locationText}">ë¶€ì‚°ì§„êµ¬ ì „í¬ë™</span>
              </li>
              <div id="distance-warning" class="text-danger fw-semibold mt-2 small"></div>

            </ul>

            <!-- ì§€ë„ -->
            <div id="map" style="width: 100%; height: 180px;" class="rounded my-3"></div>

            <!-- ë²„íŠ¼ ì˜ì—­ -->
            <div class="d-flex flex-column gap-2 mt-4">

              <div th:if="${product.status == 'RESERVED'}"
                   class="alert alert-warning text-center fw-semibold w-100 mb-0">
                í•´ë‹¹ ìƒí’ˆì€ <strong>ì˜ˆì•½ì¤‘</strong>ì…ë‹ˆë‹¤.
              </div>
              <div th:if="${product.status == 'SOLD'}"
                   class="alert alert-secondary text-center fw-semibold w-100 mb-0">
                í•´ë‹¹ ìƒí’ˆì€ <strong>íŒë§¤ì™„ë£Œ</strong>ëœ ìƒíƒœì…ë‹ˆë‹¤.
              </div>


              <div class="d-flex gap-2">
                <!-- ì°œ ë²„íŠ¼ - íŒë§¤ì™„ë£Œê°€ ì•„ë‹ ë•Œë§Œ í‘œì‹œ -->
                <div th:if="${product.status != 'SOLD'}">
                  <button type="button" class="btn btn-outline-danger w-100">
                    <i id="heart-icon" class="bi bi-heart"></i> ì°œí•˜ê¸°
                  </button>
                </div>

              <!-- ì±„íŒ…í•˜ê¸° -->
			  <!-- ìƒí’ˆ ë“±ë¡ìê°€ ì•„ë‹ ê²½ìš°ì—ë§Œ ë³´ì—¬ì¤Œ -->
              <div th:if="${session.loginUser != null and session.loginUser.userId != product.userId}">
                  <form th:action="@{/chat/start}" method="get">
                      <input type="hidden" name="targetId" th:value="${product.userId}" />
                      <button type="submit" class="btn btn-outline-primary w-100 mt-3">
                          <i class="bi bi-chat-dots"></i> ì±„íŒ…í•˜ê¸°
                      </button>
                  </form>
              </div>
                <!-- íƒë°° êµ¬ë§¤ -->
                <a th:if="${product.status == 'ONSALE' and (product.isDelivery ?: false)}"
                   th:href="@{/pay/checkout(productId=${product.productId})}"
                   class="btn btn-outline-success w-100 text-center">
                  íƒë°°ë¡œ êµ¬ë§¤í•˜ê¸°
                </a>

                <!-- ê¸€ ìˆ˜ì •í•˜ê¸° ë²„íŠ¼ ì¶”ê°€ -->
                <div th:replace="fragment/edit-button :: editButton(${product.productId}, ${product.userId})"></div>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>

  <!-- ì§€ë„ & ìŠ¬ë¼ì´ë” & ì°œ JS -->
  <script src="//dapi.kakao.com/v2/maps/sdk.js?appkey=d4ca8876da8e183543e1cfbbd669097d&libraries=services"></script>
  <script th:inline="javascript">
    var mapContainer = document.getElementById('map');
    var mapOption = {
      center: new kakao.maps.LatLng([[${product.latitude}]], [[${product.longitude}]]),
      level: 3
    };
    var map = new kakao.maps.Map(mapContainer, mapOption);
    var marker = new kakao.maps.Marker({ position: map.getCenter() });
    marker.setMap(map);
  </script>

  <script th:src="@{/js/product.js}"></script>

  <script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', function () {
      const productId = [[${product.productId}]];
      const icon = document.getElementById("heart-icon");
      const button = icon.closest("button");

      fetch(`/api/wishlist/is-wished?productId=${productId}`)
        .then(res => res.ok ? res.json() : Promise.reject())
        .then(isWished => {
          if (isWished) {
            icon.classList.replace("bi-heart", "bi-heart-fill");
          }
        });

      button.addEventListener("click", () => {
        fetch(`/api/wishlist/toggle?productId=${productId}`, { method: "POST" })
          .then(res => res.ok ? icon.classList.toggle("bi-heart") || icon.classList.toggle("bi-heart-fill")
                             : alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤."))
          .catch(() => alert("ìš”ì²­ ì‹¤íŒ¨"));
      });
    });
  </script>
  <script th:src="@{/js/product.js}"></script>
  <script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', function () {
      const currentLat = parseFloat(localStorage.getItem("selectedLat"));
      const currentLng = parseFloat(localStorage.getItem("selectedLng"));

      const productLat = [[${product.latitude}]];
      const productLng = [[${product.longitude}]];

      if (!isNaN(currentLat) && !isNaN(currentLng)) {
        const distance = calculateDistance(currentLat, currentLng, productLat, productLng);
        const warningEl = document.getElementById("distance-warning");

        if (distance > 25) {
          warningEl.innerText = `âš  í˜„ì¬ ìœ„ì¹˜ì—ì„œ ì•½ ${distance.toFixed(1)}km ë–¨ì–´ì ¸ ìˆì–´ìš”. ì§ê±°ë˜ê°€ ì–´ë ¤ìš¸ ìˆ˜ ìˆì–´ìš”.`;
        } else {
          warningEl.innerText = `ğŸ“ í˜„ì¬ ìœ„ì¹˜ ê¸°ì¤€ ì•½ ${distance.toFixed(1)}km ê±°ë¦¬ì…ë‹ˆë‹¤.`;
        }
      }

      function calculateDistance(lat1, lng1, lat2, lng2) {
        function toRad(x) { return x * Math.PI / 180; }
        const R = 6371;
        const dLat = toRad(lat2 - lat1);
        const dLon = toRad(lng2 - lng1);
        const a = Math.sin(dLat / 2) ** 2 +
          Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
          Math.sin(dLon / 2) ** 2;
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c;
      }
    });
  </script>

</div>
